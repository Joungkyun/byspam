#!/bin/sh
#
# $Id: configure,v 1.10 2004-11-30 19:24:38 oops Exp $
#
export PATH=$PATH:/bin:/sbin:/usr/bin:/usr/sbin/:/usr/local/bin:/usr/local/sbin

# include byspam version
. VERSION

byversion=${BYVERSION}
PWD=$(pwd)
INSTALLDIR=${PWD}/installdir

CHK=0


while [ "$1" != "" ]
do
  opt=$(echo $1 | sed -e 's/-//g')
  chk=$(echo $1 | egrep 'prefix|bindir|confdir|filterdir|includedir|package')
  helps=$(echo $1 | egrep '\-h')

  if [ -n "${helps}" ]; then
    eval helpmsg=1
    break
  fi
  [ -n "$chk" ] && eval $opt
  shift
done

[ -z "${package}" ] && clear

if [ -n "${helpmsg}" ]; then
  lc=$(echo ${LANG} | egrep 'ko')
  if [ -n "${lc}" ]; then
    echo "By SAPM v${BYVERSION} 설치 옵션"
    echo
    echo "사용법: configure [옵션]=[경로]"
    echo "옵션  :"
    echo "  --prefix=PREFIX   나머지 옵션들이 지정되지 않았을 경우 기본값"
    echo "                    [default: /usr/local/byspam]"
    echo "  --bindir=DIR      실행 스크립트가 위치할 디렉토리"
    echo "                    [default: \${prefix}/bin]"
    echo "  --confdir=DIR     간단한 옵션 설정 파일이 위치할 디렉토리"
    echo "                    [default: \${prefix}/conf]"
    echo "  --filterdir=DIR   필터링 설정 파일이 위치할 디렉토리"
    echo "                    [default: \${confdir}/Filter]"
    echo "  --includedir=DIR  필터링 스크립트에서 사용하는 함수가 들어갈 디렉토리"
    echo "                    [default: \${prefix}/include]"
    echo "  --perlpath=PATH   펄이 설치되어 있는 경로를 지정한다."
    echo "                    [default: /usr/bin/perl]"
    echo "  --procpath=PATH   procmailrc 가 설치되어 있는 경로를 지정한다."
    echo "                    [default: /etc/procmailrc]"
    echo "  --package=1      ./configure 시에 물어보지 않음"
    echo
  else
    echo "By SAPM v${BYVERSION} Installation Option"
    echo
    echo "Usage  : configure [option]=[vlaue]"
    echo "Options:"
    echo "  --prefix=PREFIX   install architecture-independent files in PREFIX"
    echo "                    [default: /usr/local/byspam]"
    echo "  --bindir=DIR      user executables in DIR"
    echo "                    [default: \${prefix}/bin]"
    echo "  --confdir=DIR     config file in DIR"
    echo "                    [default: \${prefix}/conf]"
    echo "  --filterdir=DIR   filtering rule config file in DIR"
    echo "                    [default: \${confdir}/Filter]"
    echo "  --includedir=DIR  filtering function files in DIR"
    echo "                    [default: \${prefix}/include]"
    echo "  --perlpath=PATH   absolute path of installed perl"
    echo "                    [default: /usr/bin/perl]"
    echo "  --procpath=PATH   absolute path of installed procmailrc"
    echo "                    [default: /etc/procmailrc]"
    echo "  --package=1      when ./configure, don't ask anything"
    echo
  fi
  exit 0
fi

echo "By SAPM ${BYVERSION} Configure"
echo "Script By JoungKyun Kim <http://www.oops.org>"
echo "Copyright 2002-2004 by BPL"
echo

echo "STEP 1. Ready Installation"
echo "----------------------------------------------------------------------"

[ -d "${INSTALLDIR}" ] && rm -rf ${INSTALLDIR}
mkdir -p ${INSTALLDIR} 2> /dev/null
CHK=$?

if [ "${CHK}" = 0 ]; then
  echo "  generating temp directory : OK"
else
  echo "  generating install directory : Failed"
  echo "  Error : Please check permission or free space of ${PWD} directory"
  echo
  exit 1
fi


echo
echo
echo "STEP 2. Option Check"
echo "----------------------------------------------------------------------"

[ -z "${prefix}" ] && prefix=/usr/local/byspam
[ -z "${bindir}" ] && bindir=${prefix}/bin
[ -z "${confdir}" ] && confdir=${prefix}/etc
[ -z "${filterdir}" ]  && filterdir=${confdir}/Filter
[ -z "${includedir}" ] && includedir=${prefix}/include
[ -z "${perlpath}" ] && perlpath=/usr/bin/perl
[ -z "${procpath}" ] && procpath=/etc/procmailrc

echo "  INSATALLATION PATH"
echo
echo "  PREFIX     : ${prefix}"
echo "  BINDIR     : ${bindir}"
echo "  CONFDIR    : ${confdir}"
echo "  FILTERDIR  : ${filterdir}"
echo "  INCLUDEDIR : ${includedir}"
echo "  PERL       : ${perlpath}"
echo "  PROCMAILRC : ${procpath}"
echo

if [ -z "${package}" ]; then
  echo -n "  Is right giving your path? [y/n] : "
  read userpath

  case "${userpath}" in
    [nN]*)
      echo
      exit 1
      ;;
  esac
fi

echo
echo
echo "STEP 3. Perl Check"
echo "----------------------------------------------------------------------"

PERLCHK=$(which perl 2> /dev/null)
echo "This program requires perl and MIME-Base64 module"
echo
if [ -n "${perlpath}"  ]; then
  PERLPATH=${perlpath}
  if [ -f "${PERLPATH}" ]; then
    echo "  PERL installation check    : OK"
  else
    echo "  PERL installation check    : Failed"
    echo "  Error: Can't find ${PERLPATH}. Return Again"
    echo
    exit 1
  fi
else
  while true
  do
    echo -n "  Typing path of perl [ ${PERLCHK} ] : "
    read PERLPATH
    [ -z "${PERLPATH}" ] && PERLPATH=${PERLCHK}

    if [ -f "${PERLPATH}" ]; then
      echo "  PERL installation check    : OK"
      break
    else
      echo "  PERL installation check    : Failed"
      echo "  Error: Can't find ${PERLPATH}. Return Again"
      echo
    fi
  done
fi

for i in byspamFilter byspamTrash plain.pl regexChk.pl
do
  ${PERLPATH} -p -e "s!\@PERLPATH\@!${PERLPATH}!g" bin/${i} > ${INSTALLDIR}/${i}
  chmod 755 ${INSTALLDIR}/${i}
done

MIMEMODCHK=0
${PERLPATH} -e "use MIME::Base64;" > /dev/null 2>&1
MIMEMODCHK=$?

if [ "${MIMEMODCHK}" = "0" ]; then
  echo "  checked MIME-BASE64 module : OK"
else
  echo "  checked MIME-BASE64 module : FAILED"
  echo "  See also ENVIRONMENT document"
  exit 1
fi




echo
echo
echo "STEP 4. Configure Script of By SPAM"
echo "----------------------------------------------------------------------"

for i in byspam.cron byspamFilter byspamTrash plain.pl
do
  if [ ${i} = "byspam.cron" ]; then
    ${PERLPATH} -p -e "s!\@confdir\@!${confdir}!g" ./bin/${i} > ${INSTALLDIR}/${i}
    CHK=$?
  else
    ${PERLPATH} -p -i -e "s!\@confdir\@!${confdir}!g" ${INSTALLDIR}/${i}
    ${PERLPATH} -p -i -e "s!\@includedir\@!${includedir}!g" ${INSTALLDIR}/${i}
    CHK=$?
    [ "${CHK}" = "0" ] && CHK=$?
  fi

  if [ "${CHK}" = 0 ]; then
    chmod 755 ${INSTALLDIR}/${i}
    echo "  configred .. ${i}"
  else
    rm -rf ${INSTALLDIR}
    echo "  Error: removed install directory"
    exit 1
  fi
done

mv -f ${INSTALLDIR}/plain.pl ${INSTALLDIR}/byspamPlain
mv -f ${INSTALLDIR}/regexChk.pl ${INSTALLDIR}/byspamRegexChk

${PERLPATH} -p -e "s!\@bindir\@!${bindir}!g" ./etc/filter.rc > ${INSTALLDIR}/filter.rc
CHK=$?

if [ "${CHK}" = 0 ]; then
  chmod 644 ${INSTALLDIR}/filter.rc
  echo "  configred .. filter.rc"
else
  rm -rf ${INSTALLDIR}
  echo "  Error: removed install directory"
  exit 1
fi

for i in level bindir confdir filterdir includedir PERLPATH datadir byversion
do
  eval tostr='$'${i}

  if [ "${i}" = "level" ]; then
    cp -af ./etc/byspam.conf ${INSTALLDIR}/byspam.conf
    CHK=$?
  else
    ${PERLPATH} -p -i -e "s!\@${i}\@!${tostr}!g" ${INSTALLDIR}/byspam.conf
    [ "${CHK}" = 0 ] && CHK=$?
  fi

  if [ "${CHK}" != 0 ]; then
    rm -rf ${INSTALLDIR}
    echo "  Error: removed install directory"
    exit 1
  fi
done

if [ "${CHK}" = 0 ]; then
  chmod 644 ${INSTALLDIR}/byspam.conf
  echo "  configred .. byspam.conf"
fi

echo
echo
echo "STEP 5. Make INSTALL PROGRAM"
echo "----------------------------------------------------------------------"
echo
echo

conv="prefix bindir confdir filterdir includedir INSTALLDIR PERLPATH procpath package"

for i in ${conv}
do
  catfile="/tmp/byspam-installfile"
  eval chg='$'${i}

  if [ "${i}" = "prefix" ]; then
    cp -af ./install.in ${catfile}
  fi

  ${PERLPATH} -p -i -e "s!\@${i}\@!${chg}!g" ${catfile}
  [ "$CHK" = 0 ] && CHK=$?

  printf "  create %10s data in install file   : " "${i}"
  if [ "${CHK}" = 0 ]; then
    echo "OK"
  else
    echo "Failed"
    rm -rf ${INSTALLDIR}
    exit 1
  fi
done


conv="bindir confdir filterdir includedir procpath byversion PERLPATH"

for i in ${conv}
do
  catfile="/tmp/byspam-uninstallfile"

  eval chg='$'${i}

  if [ "${i}" = "bindir" ]; then
    cp -af ./uninstall.in ${catfile}
  fi

  ${PERLPATH} -p -i -e "s!\@${i}\@!${chg}!g" ${catfile}
  [ "$CHK" = 0 ] && CHK=$?

  printf "  create %10s data in uninstall file : " "${i}"
  if [ "${CHK}" = 0 ]; then
    echo "OK"
  else
    echo "Failed"
    rm -f /tmp/byspam-uninstallfile
    exit 1
  fi
done

echo "# Never touch or remove this file!!!" > ${INSTALLDIR}/install.log
CHK=$?
echo "perlpath=${PERLPATH}" >> ${INSTALLDIR}/install.log
[ "${CHK}" = 0 ] && CHK=$?
echo "procpath=${procpath}" >> ${INSTALLDIR}/install.log
[ "${CHK}" = 0 ] && CHK=$?
echo "prefix=${prefix}" >> ${INSTALLDIR}/install.log
[ "${CHK}" = 0 ] && CHK=$?
echo "bindir=${bindir}" >> ${INSTALLDIR}/install.log
[ "${CHK}" = 0 ] && CHK=$?
echo "confdir=${confdir}" >> ${INSTALLDIR}/install.log
[ "${CHK}" = 0 ] && CHK=$?
echo "filterdir=${filterdir}" >> ${INSTALLDIR}/install.log
[ "${CHK}" = 0 ] && CHK=$?
echo "includedir=${includedir}" >> ${INSTALLDIR}/install.log
[ "${CHK}" = 0 ] && CHK=$?

if [ "${CHK}" = 0 ]; then
  echo "  create install log file : OK"
else
  echo "  create install log file : Failed"
  rm -f /tmp/byspam-uninstallfile
  exit 1
fi

install -m755 /tmp/byspam-uninstallfile ${INSTALLDIR}/byspamUninstall
[ "$CHK" = 0 ] && CHK=$?

if [ "${CHK}" = 0 ]; then
  rm -f /tmp/byspam-uninstallfile
  echo
  echo "  Creating uninstall file completed."
  echo
else
  echo "  Creating uninstall file failed."
  echo
  rm -rf ${INSTALLDIR}
  exit 1
fi


install -m755 /tmp/byspam-installfile ./install
[ "$CHK" = 0 ] && CHK=$?

if [ "${CHK}" = 0 ]; then
  rm -f /tmp/byspam-installfile
  echo
  echo "  Creating install file completed. Now you can run install."
  echo
else
  echo "  Creating uninstall file failed."
  echo
  rm -rf ${INSTALLDIR}
  exit 1
fi

