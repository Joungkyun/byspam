#!/bin/sh
VERSION="1.0.0"

USERPRIV=$(whoami)

if [ "${USERPRIV}" = "root" ]; then
  if [ -z "${1}" ]; then
    USERPRIV=root
  else
    USERPRIV=$1
  fi
  USEROPT="-u $1"
fi
USERPATH=$(cat /etc/passwd | grep "^${USERPRIV}" | awk -F ":" '{print $6}')
USERPATH=$(echo ${USERPATH} | sed 's/\/$//g')
TRASHPATH="${USERPATH}/byspam"

nextfunc() {
  case "${next}" in
    x)
       exit 0
       ;;
    b)
       if [ -z "${nullchk}" ]; then
         start=$[${start}-${limit}*2] 
         until=$[${until}-${limit}*2]
         page=$[${page}-1]
       else
         start=$[${startl}-${limit}*2] 
         until=$[${untill}-${limit}*2]
         page=$[${page}-1]
       fi

       # 시작이 1 보다 작을 경우
       if [ ${start} -lt 1 ]; then
         start=1
         until=1
         page=1
       fi
       ;;
    d* )
       for i in ${next}
       do
         if [ "${i}" != "d" ]; then
           eval "checkfile=\$TRASHFILE${i}"
           checkfile=$(echo $checkfile | sed 's/^[^\-]*-//g')
           if [ -f "${USERPATH}/byspam/spam-${checkfile}" ]; then
             @bindir@/byspamTrashFile ${USEROPT} -x ${checkfile}
           fi
           checkfile=
         fi
       done

       # 리스트 재정렬
       TRASHBOX=$(ls "${TRASHPATH}" | grep "spam-" | grep -v grep | sort -r 2> /dev/null)
       j=1
       no=1
       for i in ${TRASHBOX}
       do
         eval "TRASHFILE${j}=${i}"
         j=$[${j}+1]
       done
       eval "TRASHFILE${j}="

       totalart=$[${j}-1]
       n=$[${totalart}/${limit}]
       p=$[${totalart}%${limit}]

       if [ ${p} -gt 0 ]; then
         totalpage=$[${n}+1]
       else
         totalpage=${n}
       fi

       start=${startl}
       until=${untill}
       ;;
    *[!0-9]* | "")
       page=$[${page}+1]

       if [ ${page} -gt ${totalpage} ]; then
         page=${totalpage}
       fi
       ;;
    *)
       eval "checkfile=\$TRASHFILE${next}"
       checkfile=$(echo $checkfile | sed 's/^[^\-]*-//g')
       if [ -f "${USERPATH}/byspam/spam-${checkfile}" ]; then
         @bindir@/byspamTrashFile ${USEROPT} -d ${checkfile}
       fi

       start=${startl}
       until=${untill}
  esac
}

TRASHBOX=$(ls "${TRASHPATH}" | grep "spam-" | grep -v grep | sort -r 2> /dev/null)

j=1
no=1
start=1
limit=10
page=1

for i in ${TRASHBOX}
do
  eval "TRASHFILE${j}=${i}"
  j=$[${j}+1] 
done

totalart=$[${j}-1]
n=$[${totalart}/${limit}]
p=$[${totalart}%${limit}]

if [ ${p} -gt 0 ]; then
  totalpage=$[${n}+1]
else
  totalpage=${n}
fi

until=1
while [ true ]
do
  clear
  echo "============================================================================="
  echo "by SPAM Trash VIEWER $VERSION by JoungKyun Kim <http://www.oops.org>"
  echo "Command [ x - exit | no - mail no | d no - del no | enter - next | b - back ]"
  echo "============================================================================="
  echo "Total ${totalpage} page / Current ${page} page"
  echo

  startl=${start}
  untill=${until}
  until=$[${until}+${limit}]

  if [ ${totalart} = 0 ]; then
    echo "WORN : No exist trash file"
  else
    while [ true ]
    do
      eval "FILENAME=\$TRASHFILE${start}"

      if [ ${start} -lt 10 ]; then
        stno="   ${start}"
      elif [ ${start} -lt 100 ]; then
        stno="  ${start}"
      elif [ ${start} -lt 1000 ]; then
        stno=" ${start}"
      else
        stno=${start}
      fi
      if [ ${start} -lt ${until} ] && [ -n "${FILENAME}" ]; then
        echo "${stno}. ${FILENAME}"
        start=$[${start}+1]
      else
        if [ -z "${FILENAME}" ]; then
          start=${startl}
          until=${untill}
          nullchk=1
        else
          nullchk=
        fi
        break
      fi
    done
  fi

  echo
  echo "-----------------------------------------------------------------------------"
  echo -n "Command: "

  if [ ${totalart} = 0 ]; then
    exit 0
  else
    read next
  fi
  nextfunc
done

exit 0
