#!@PERLPATH@
use Mail::Internet;
use Mail::Header;
use MIME::Base64;
use MIME::QuotedPrint;

local $includeDir;

my $i = 0;
my $enc;
my $exm;
my $text;
my $less;
my $copy;
my $trash;
my $start;
my $until;
my $mailno;
my $getMail;
my $subjectTmp;
my @subject = ();
my @bodyis = ();
my @devide = ();
my @tmpMail = ();
my $homedir = $ENV{"HOME"};
my $myuser = $ENV{"USER"};

# Local ENV
my $users = "";
my $dfile = "";
my $filedates = "";

do "@confdir@/byspam.conf";
do "$includeDir/byspamFunction.pl";

$copy = "By SAPM TRASH VIEW v1.0.0".
        "by JoungKyun Kim <http://www.oops.org>\n";

$homedir =~ s/\/$//g;

use Time::gmtime;
my $byspamYear = gmtime->year() + 1900;
my $byspamMon  = gmtime->mon() + 1;
my $byspamDay  = gmtime->mday() + 1;
if($byspamMon < 10) { $byspamMon = "0$byspamMon"; }
if($byspamDay < 10) { $byspamDay = "0$byspamDay"; }

if ( $#ARGV < 0 ) {
  $trash = "$homedir/byspam/spam-$byspamYear$byspamMon$byspamDay";
} else {
  for ($i=0; $i <= $#ARGV; $i++) {
    if ($ARGV[$i] eq "-u") {
      if ($myuser eq "root") {
        $users = $ARGV[$i+1];
        $users = `cat /etc/passwd | grep \"^$users:\" | awk -F : '{print \$6}'`;
        $users =~ s/\n|\/$//g;
      } else {
        print $copy;
        print "Error: Only root user excute wiht -u option\n";
        exit;
      }
    } elsif ($ARGV[$i] eq "-d") {
      $filedates = $ARGV[$i+1];
    } elsif ($ARGV[$i] eq "-x") {
      $dfile = $ARGV[$i+1];
    }
    $i++;
  }

  if ($users eq "") { $users = $homedir; }
  if ($filedates eq "") { $filedates = "$byspamYear$byspamMon$byspamDay"; }

  $trash = "$users/byspam/spam-$filedates";
}

# delete mode
if ($dfile ne "") {
  $dfile = "$users/byspam/spam-$dfile";

  if ( -f "$dfile" ) {
    unlink $dfile;
  }
  exit 0;
}

if( ! -f "$trash" ) {
  print $copy;
  print "Error: Trash file not found\n";
  print "Usage: byspamTrashFile [ -u/-d/-x ]\n\n";
  print "       -u USERNAME (only root)\n";
  print "       -d DATE_FORMAT (Ymd, default value is today)\n";
  print "       -x DATE_FORMAT (delete DATE_FORMAT trash file)\n\n";
  if($myuser eq "root") {
    print "       View Mode   : byspamTrashFile -u oops -d 20020627\n";
    print "       Delete Mode : byspamTrashFile -u oops -x 20020627\n";
  } else {
    print "       View Mode   : byspamTrashFile -d 20020627\n";
    print "       Delete Mode : byspamTrashFile -x 20020627\n";
  }
  exit 0;
}

$less = `less --help`;

sub splitMail {
  my $st = 0;
  my $i = 0;
  my $mailTmp;
  my @mailx = ();

  if( -f $_[0] ) {
    open(fileHandle,$_[0]);
    foreach(<fileHandle>) {
      if(/^From[ ]+[^@]+@[^ ]+[ ]+[A-Z][a-z]{2}[ ]+[A-Z][a-z]{2}[ ]+/) {
        if($st ne 0) {
          $mailx[$i] = $mailTmp;
          $i++;
        } else { $st = 1; }
        $mailTmp=$_;
      } else {
        $mailTmp .= $_;
      }
    }
    $mailx[$i] = $mailTmp;
    close(fileHandle);
  } else {
    print "Error: Can't not find $trash\n";
    exit 0
  }

  return @mailx;
}

my @mails = splitMail("$trash");
chomp(@mails);
$mailSize = @mails;

for($i=0;$i<$mailSize;$i++) {
  $mails[$i] =~ s/\n/!byspamEnter!\n/g;
  @tmpMail = split(/\n/,$mails[$i]);
  $getMail = Mail::Internet->new(\@tmpMail);
  $subject[$i] = $getMail->get("Subject:");
  $subject[$i] =~ s/\s*Subject: .+|!byspamEnter!//g;
  $subject[$i] =~ s/\s+/ /ig;
  chomp($subject[$i]);

  if($subject[$i] =~ /^\s*$/i) { $subject[$i] = "No Subject"; }

  my $resSubj;
  if($subject[$i] =~ /=\?[^?]+\?([BQ])\?/i) {
    my @chkSubj = ();
    my $chkSubjSize;
    @chkSubj = split(/\s+/,$subject[$i]);
    $chkSubjSize = @chkSubj;
    for($ci=0;$ci<$chkSubjSize;$ci++) {
      if($chkSubj[$ci] =~ /=\?[^?]+\?([BQ])\?/i) {
        $enc = $chkSubj[$ci];
        $enc =~ s/(=\?[^?]+\?([BQ])\?[^?]+\?=)+/$2/ig;
        $chkSubj[$ci] =~ s/=\?[^?]+\?[BQ]\?([^?]+)\?=/$1/ig;

        if ($enc =~ /^q/i) { $chkSubj[$ci] = decode_qp($chkSubj[$ci]); }
        else { $chkSubj[$ci] = decode_base64($chkSubj[$ci]); }
      }

      $resSubj = $resSubj ? "$resSubj $chkSubj[$ci]" : $chkSubj[$ci];
      chomp($resSubj);
    }
  }

  $subject[$i] = $resSubj ? $resSubj : $subject[$i];
  $bodyis[$i] = getBody($getMail);
}

my $lastpage = $mailSize/10;
my $lastchk  = int $lastpage;
if($lastchk < $lastpage) { $lastpage = $lastchk+1; }

my $page = 1;
LINE: while (1) {
  system("clear");
  print "=============================================================================\n";
  print "$copy";
  print "=============================================================================\n";
  print "Curren Date: $filedates\n";
  print "$page page / total $lastpage pages\n\n";

  $start = ($page > 1) ? $mailSize - ($page * 10 - 10) - 1 : $mailSize - 1;
  $until = ($start - 10 < -1) ? -1 : $start - 10;

  my $j;
  for($i=$start;$i>$until;$i--) {
    $j = $i+1;
    if($j < 10) { $sp = "    "; }
    elsif($j < 100) { $sp = "   "; }
    elsif($j < 1000) { $sp = "  "; }
    elsif($j < 10000) { $sp = " "; }
    $j = "$sp$j";
    print "$j. $subject[$i]\n";
  }

  print "-----------------------------------------------------------------------------\n";
  print "Command: ";
  my $cmd = <STDIN>;
  chomp $cmd;


  # view mail context
  if ($cmd =~ /^[0-9]+$/) {
    if ($cmd <= $start+1 && $cmd > $until+1) {
      $mailno = $cmd - 1;      
      system("clear");
      $printBody = "$copy".
                   "$page page / total $lastpage pages\n\n".
                   "Mail No. $cmd\n".
                   "Subject. $subject[$mailno]\n\n".
                   "$bodyis[$mailno]\n";

      if ($less) {
        $printBody =~ s/'/`/g;
        system("echo '$printBody' | less -e");
        redo;
      } else {
        print "$printBody"; 
        print "\nDo you want to continue? [y/n] : ";
        $cmd = <STDIN>;
        chomp $cmd;

        if($cmd !~ /^(y|$)/i) { last LINE; }
        else { redo; }
      }
    } else {
      print "Out of a scope of mail list\n";
      redo;
    }
  }

  if ($until == -1 && $cmd !~ /^b/i) { last LINE; }
  elsif($cmd !~ /^(y|b|\s*$)/i) { last LINE; }
  elsif($cmd =~ /^b/i && $page eq 1) {}
  elsif($cmd =~ /^b/i && $page > 1) { $page--;  }
  else { $page++; }
}

exit 1;
